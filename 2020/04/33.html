
<!DOCTYPE html>
<html lang="zh-CN ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云淡风轻 || Python语音识别折腾记</title>
    <meta name="author" content="Ne-21">
    <meta name="description" content="放弃不难，但坚持一定很酷。 ">
    <meta name="keywords" content="云淡风轻, hexo, various, python, html, 小刀娱乐网, 编程, 自学 ">
    <link rel="icon" href="/https://imgs.521daigua.cn/blog/tx.jpeg">
    <link rel="stylesheet" href="/css/antd.min.css">
    
    <link rel="stylesheet" href="/css/maiden-theme.css">
    
    <script src="/js/vue.js"></script>
    <script src="/js/antd.min.js"></script>
<meta name="generator" content="Hexo 5.3.0"></head>

<body>

    <div id="loading"
        style="height: 100vh; width: 100%; position: fixed;display: flex;z-index: 200; justify-content: space-between;">
        <div id="loadleft" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div id="loadright" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div
            style="position: fixed; height: 100vh; width: 100%;display: flex;justify-content: center;align-items: center;">
            <div id="loadcontent"
                style="width:400px;height:400px;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px#a3ddfb; text-align:center;opacity:1;transition:opacity 0.3s ease-out;">
                <div>
                    <h2>LOADING...</h2>
                    <p>加载过慢请开启缓存(浏览器默认开启)</p>
                    <div>
                        <img src="/dancingkitty.gif" alt="loading">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="layout">
        <transition name="into">
            <div v-show="show_page" style="display: none;">
                <div id="menu_show">
                     
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">云淡风轻</span>
        </a>
        
        <a href="/">
            <span>
                <a-icon type="home" theme="filled" />
            </span>
            <span>首页</span>
        </a>
        
        <a href="/about">
            <span>
                <a-icon type="user" theme="filled" />
            </span>
            <span>关于</span>
        </a>
        
        <a href="/archives">
            <span>
                <a-icon type="bars" theme="filled" />
            </span>
            <span>归档</span>
        </a>
        
        <a href="/tags">
            <span>
                <a-icon type="tags" theme="filled" />
            </span>
            <span>标签</span>
        </a>
        
    </div>

    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div :class="'title'" @click="menu_show=!menu_show">
            <span style="margin-right: 10px;">
                <a-icon type="appstore" theme="filled" />
            </span>
            <span>云淡风轻</span>
        </div>
        <div class="items" v-show="menu_show">
            
            <a href="/">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="home" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">首页</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="user" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">关于</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="bars" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">归档</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="tags" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">标签</div>
                </div>
            </a>
            
        </div>
        <div class="curtain" v-show="menu_show"></div>
    </div>

</nav>
                </div>

                <div id="main">
                     
<link rel="stylesheet" href="/css/post-body.css">
<div class="article">
    <div>
        <h1>Python语音识别折腾记 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <a-icon type="calendar" theme="filled" />
            </span>
            2020/4/9
        </span>

        

        

        <span class="tags">
            <span class="icon">
                <a-icon type="tags" theme="filled" />
            </span>
            
            <span class="tag">
                
                <a href="/tags/python" style=color:#ff7d73>
                    python
                </a>
            </span>
            
        </span>
        
    </div>

    <div class="content" v-pre>
        <blockquote>
<p>今天好不容易休息半天，但是又被英语作业给折服了，就上一次<a href="https://gocos.cn/2020/03/29.html">U校园半自动化</a>造福大学生之后，就有这么一个想法，是什么呢？<br>就是能不能把听力的内容识别出来，变成文本。这样就可以看听力文本了，那答题岂不是很简单？<br>ok，废话不多说，下面就来介绍下自己的折腾日记和遇到的问题</p>
</blockquote>
<h1 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1><p>我们第一步要做的就是拿到听力文件，怎么拿呢？——抓包<br>由于过于简单，我只说大概步骤，具体百度<br><code>登陆——进入听力测验——按F12打开开发者工具——点击音频播放按钮——看工具里的最后一个资源——双击该资源进入——下载音频</code></p>
<h1 id="音频格式转换"><a href="#音频格式转换" class="headerlink" title="音频格式转换"></a>音频格式转换</h1><p>我们拿到的音频格式是MP3格式的，按照<a target="_blank" rel="noopener" href="https://ai.baidu.com/ai-doc/SPEECH/Vk38lxily">百度语音识别的文档</a>来说支持音频格式：pcm、wav、amr、m4a的音频，<br>当然我在这里卡住了，用格式工厂转码后进行识别会报错，由于格式工厂没有pcm格式，所以我在这里纠结怎么转换，当然百度也给出了<a target="_blank" rel="noopener" href="https://ai.baidu.com/ai-doc/SPEECH/7k38lxpwf">转换方法</a><br>我这里还没研究明白，恳请大佬指点，下面我们只能用百度提供的示例音频做演示了QAQ</p>
<h1 id="在百度智能云开通服务"><a href="#在百度智能云开通服务" class="headerlink" title="在百度智能云开通服务"></a>在百度智能云开通服务</h1><p>1.登陆<a target="_blank" rel="noopener" href="https://login.bce.baidu.com/?account=&redirect=http://console.bce.baidu.com/">百度智能云</a><br>2.<img src="https://s1.ax1x.com/2020/04/09/G5RH6H.png" alt="2"><br>3.<img src="https://ae01.alicdn.com/kf/H2c23f18f5055486ab6756f3fb584498ei.png" alt="3"><br>4.<img src="https://ae01.alicdn.com/kf/Hba63e7bd6da14287a237bf5504f519eb2.png" alt="4"><br>5.<img src="https://ae01.alicdn.com/kf/H9b980f96caea4f60913b8cef7d2c4742i.png" alt="5"><br>6.<img src="https://ae01.alicdn.com/kf/H43e62f8f01f94c3e97bf74740a61cd08o.png" alt="6"><br>7.创建成功后，我们就会获得api-key,secret-key（后面会用到）<br><img src="https://ae01.alicdn.com/kf/H7bd399a826824546bbddf77b6ac324d6a.png" alt="7"></p>
<h1 id="开始在python构造请求"><a href="#开始在python构造请求" class="headerlink" title="开始在python构造请求"></a>开始在python构造请求</h1><p>这里我们直接使用百度提供的<a target="_blank" rel="noopener" href="https://github.com/Baidu-AIP/speech-demo/tree/master/rest-api-asr/python">DEMO</a>,然后自己做一些修改</p>
<ul>
<li><p>安装依赖库(利用pip,不懂请自行百度)</p>
</li>
<li><p><code>pip install baidu-aip</code> # 百度语音识别Python SDK</p>
</li>
<li><p><code>pip install urllib</code> # 网页请求库</p>
</li>
<li><p>开始构造代码（注意看注释）</p>
<pre><code># coding=utf-8
</code></pre>
</li>
</ul>
<h1 id="引入所需库"><a href="#引入所需库" class="headerlink" title="引入所需库"></a>引入所需库</h1><p>import sys<br>import json<br>import base64<br>import time</p>
<p>IS_PY3 = sys.version_info.major == 3</p>
<p>if IS_PY3:<br>    from urllib.request import urlopen<br>    from urllib.request import Request<br>    from urllib.error import URLError<br>    from urllib.parse import urlencode<br>    timer = time.perf_counter<br>else:<br>    from urllib2 import urlopen<br>    from urllib2 import Request<br>    from urllib2 import URLError<br>    from urllib import urlencode<br>    if sys.platform == “win32”:<br>        timer = time.clock<br>    else:<br>        # On most other platforms the best timer is time.time()<br>        timer = time.time</p>
<h1 id="设置api-key-secret-key-此数据在上文有提及"><a href="#设置api-key-secret-key-此数据在上文有提及" class="headerlink" title="设置api-key,secret-key  此数据在上文有提及"></a>设置api-key,secret-key  此数据在上文有提及</h1><p>API_KEY = ‘你的api-key’<br>SECRET_KEY = ‘你的secret-key’</p>
<h1 id="需要识别的文件-audio-16k-pcm为音频文件路径，例如在D盘，那就是D-audio-16k-pcm"><a href="#需要识别的文件-audio-16k-pcm为音频文件路径，例如在D盘，那就是D-audio-16k-pcm" class="headerlink" title="需要识别的文件  ./audio/16k.pcm为音频文件路径，例如在D盘，那就是D:/audio/16k.pcm"></a>需要识别的文件  ./audio/16k.pcm为音频文件路径，例如在D盘，那就是D:/audio/16k.pcm</h1><p>AUDIO_FILE = ‘./audio/16k.pcm’  # 只支持 pcm/wav/amr 格式，极速版额外支持m4a 格式</p>
<h1 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h1><p>FORMAT = AUDIO_FILE[-3:]  # 文件后缀只支持 pcm/wav/amr 格式，极速版额外支持m4a 格式</p>
<h1 id="电脑mac地址，个人感觉没用，默认即可"><a href="#电脑mac地址，个人感觉没用，默认即可" class="headerlink" title="电脑mac地址，个人感觉没用，默认即可"></a>电脑mac地址，个人感觉没用，默认即可</h1><p>CUID = ‘123456PYTHON’</p>
<h1 id="采样率"><a href="#采样率" class="headerlink" title="采样率"></a>采样率</h1><p>RATE = 16000  # 固定值</p>
<h1 id="普通版"><a href="#普通版" class="headerlink" title="普通版"></a>普通版</h1><p>DEV_PID = 1537  # 1537 表示识别普通话，使用输入法模型。根据文档填写PID，选择语言及识别模型<br>ASR_URL = ‘<a target="_blank" rel="noopener" href="http://vop.baidu.com/server_api&#39;">http://vop.baidu.com/server_api&#39;</a><br>SCOPE = ‘audio_voice_assistant_get’  # 有此scope表示有asr能力，没有请在网页里勾选，非常旧的应用可能没有</p>
<p>#测试自训练平台需要打开以下信息， 自训练平台模型上线后，您会看见 第二步：“”获取专属模型参数pid:8001，modelid:1234”，按照这个信息获取 dev_pid=8001，lm_id=1234</p>
<h1 id="DEV-PID-8001"><a href="#DEV-PID-8001" class="headerlink" title="DEV_PID = 8001 ;"></a>DEV_PID = 8001 ;</h1><h1 id="LM-ID-1234"><a href="#LM-ID-1234" class="headerlink" title="LM_ID = 1234 ;"></a>LM_ID = 1234 ;</h1><h1 id="极速版-打开注释的话请填写自己申请的appkey-appSecret-，并在网页中开通极速版（开通后可能会收费）"><a href="#极速版-打开注释的话请填写自己申请的appkey-appSecret-，并在网页中开通极速版（开通后可能会收费）" class="headerlink" title="极速版 打开注释的话请填写自己申请的appkey appSecret ，并在网页中开通极速版（开通后可能会收费）"></a>极速版 打开注释的话请填写自己申请的appkey appSecret ，并在网页中开通极速版（开通后可能会收费）</h1><h1 id="DEV-PID-80001"><a href="#DEV-PID-80001" class="headerlink" title="DEV_PID = 80001"></a>DEV_PID = 80001</h1><h1 id="ASR-URL-‘http-vop-baidu-com-pro-api-39"><a href="#ASR-URL-‘http-vop-baidu-com-pro-api-39" class="headerlink" title="ASR_URL = ‘http://vop.baidu.com/pro_api&#39;"></a>ASR_URL = ‘<a target="_blank" rel="noopener" href="http://vop.baidu.com/pro_api&#39;">http://vop.baidu.com/pro_api&#39;</a></h1><h1 id="SCOPE-‘brain-enhanced-asr’-有此scope表示有极速版能力，没有请在网页里开通极速版"><a href="#SCOPE-‘brain-enhanced-asr’-有此scope表示有极速版能力，没有请在网页里开通极速版" class="headerlink" title="SCOPE = ‘brain_enhanced_asr’  # 有此scope表示有极速版能力，没有请在网页里开通极速版"></a>SCOPE = ‘brain_enhanced_asr’  # 有此scope表示有极速版能力，没有请在网页里开通极速版</h1><h1 id="忽略scope检查，非常旧的应用可能没有"><a href="#忽略scope检查，非常旧的应用可能没有" class="headerlink" title="忽略scope检查，非常旧的应用可能没有"></a>忽略scope检查，非常旧的应用可能没有</h1><h1 id="SCOPE-False"><a href="#SCOPE-False" class="headerlink" title="SCOPE = False"></a>SCOPE = False</h1><p>class DemoError(Exception):<br>    pass</p>
<p>“””  TOKEN start “””</p>
<p>TOKEN_URL = ‘<a target="_blank" rel="noopener" href="http://openapi.baidu.com/oauth/2.0/token&#39;">http://openapi.baidu.com/oauth/2.0/token&#39;</a></p>
<p>def fetch_token():<br>    params = {‘grant_type’: ‘client_credentials’,<br>              ‘client_id’: API_KEY,<br>              ‘client_secret’: SECRET_KEY}<br>    post_data = urlencode(params)<br>    if (IS_PY3):<br>        post_data = post_data.encode( ‘utf-8’)<br>    req = Request(TOKEN_URL, post_data)<br>    try:<br>        f = urlopen(req)<br>        result_str = f.read()<br>    except URLError as err:<br>        print(‘token http response http code : ‘ + str(err.code))<br>        result_str = err.read()<br>    if (IS_PY3):<br>        result_str =  result_str.decode()</p>
<pre><code>print(result_str)
result = json.loads(result_str)
print(result)
if (&#39;access_token&#39; in result.keys() and &#39;scope&#39; in result.keys()):
    print(SCOPE)
    if SCOPE and (not SCOPE in result[&#39;scope&#39;].split(&#39; &#39;)):  # SCOPE = False 忽略检查
        raise DemoError(&#39;scope is not correct&#39;)
    print(&#39;SUCCESS WITH TOKEN: %s  EXPIRES IN SECONDS: %s&#39; % (result[&#39;access_token&#39;], result[&#39;expires_in&#39;]))
    return result[&#39;access_token&#39;]
else:
    raise DemoError(&#39;MAYBE API_KEY or SECRET_KEY not correct: access_token or scope not found in token response&#39;)
</code></pre>
<p>“””  TOKEN end “””</p>
<p>if <strong>name</strong> == ‘<strong>main</strong>‘:<br>    token = fetch_token()</p>
<pre><code>speech_data = []
with open(AUDIO_FILE, &#39;rb&#39;) as speech_file:
    speech_data = speech_file.read()

length = len(speech_data)
if length == 0:
    raise DemoError(&#39;file %s length read 0 bytes&#39; % AUDIO_FILE)
speech = base64.b64encode(speech_data)
if (IS_PY3):
    speech = str(speech, &#39;utf-8&#39;)
params = &#123;&#39;dev_pid&#39;: DEV_PID,
         #&quot;lm_id&quot; : LM_ID,    #测试自训练平台开启此项
          &#39;format&#39;: FORMAT,
          &#39;rate&#39;: RATE,
          &#39;token&#39;: token,
          &#39;cuid&#39;: CUID,
          &#39;channel&#39;: 1,
          &#39;speech&#39;: speech,
          &#39;len&#39;: length
          &#125;
post_data = json.dumps(params, sort_keys=False)
# print post_data
req = Request(ASR_URL, post_data.encode(&#39;utf-8&#39;))
req.add_header(&#39;Content-Type&#39;, &#39;application/json&#39;)
try:
    begin = timer()
    f = urlopen(req)
    result_str = f.read()
    print (&quot;Request time cost %f&quot; % (timer() - begin))
except URLError as err:
    print(&#39;asr http response http code : &#39; + str(err.code))
    result_str = err.read()

if (IS_PY3):
    result_str = str(result_str, &#39;utf-8&#39;)
print(result_str)
with open(&quot;result.txt&quot;,&quot;w&quot;) as of:
    of.write(result_str)
</code></pre>
<pre><code>
# 运行程序
我们运行程序后或返回一下信息
</code></pre>
<p>{“access_token”:”24.0ed58d5f890b6388b8e1fbb4f595e64e.2592000.1589017415.282335-19345000”,”session_key”:”9mzdC33+ru+xjYD0Bs+vqaaCurlrknFs75w6pvM+ddSFc9hWFqSn0t8aW8gWU7qWGl21RSTcM4A1bevZRf5m2labdgfjvA==”,”scope”:”audio_voice_assistant_get brain_enhanced_asr audio_tts_post public brain_all_scope picchain_test_picchain_api_scope wise_adapt lebo_resource_base lightservice_public hetu_basic lightcms_map_poi kaidian_kaidian ApsMisTest_Test\u6743\u9650 vis-classify_flower lpq_\u5f00\u653e cop_helloScope ApsMis_fangdi_permission smartapp_snsapi_base iop_autocar oauth_tp_app smartapp_smart_game_openapi oauth_sessionkey smartapp_swanid_verify smartapp_opensource_openapi smartapp_opensource_recapi qatest_scope1 fake_face_detect_\u5f00\u653eScope vis-ocr_\u865a\u62df\u4eba\u7269\u52a9\u7406 idl-video_\u865a\u62df\u4eba\u7269\u52a9\u7406”,”refresh_token”:”25.ccc2be055d9e6273d3c0bad9b8bb2368.315360000.1901785415.282335-19345000”,”session_secret”:”a0a53e0d2183b7145217373b71784075”,”expires_in”:2592000}<br>{‘access_token’: ‘24.0ed58d5f890b6388b8e1fbb4f595e64e.2592000.1589017415.282335-19345000’, ‘session_key’: ‘9mzdC33+ru+xjYD0Bs+vqaaCurlrknFs75w6pvM+ddSFc9hWFqSn0t8aW8gWU7qWGl21RSTcM4A1bevZRf5m2labdgfjvA==’, ‘scope’: ‘audio_voice_assistant_get brain_enhanced_asr audio_tts_post public brain_all_scope picchain_test_picchain_api_scope wise_adapt lebo_resource_base lightservice_public hetu_basic lightcms_map_poi kaidian_kaidian ApsMisTest_Test权限 vis-classify_flower lpq_开放 cop_helloScope ApsMis_fangdi_permission smartapp_snsapi_base iop_autocar oauth_tp_app smartapp_smart_game_openapi oauth_sessionkey smartapp_swanid_verify smartapp_opensource_openapi smartapp_opensource_recapi qatest_scope1 fake_face_detect_开放Scope vis-ocr_虚拟人物助理 idl-video_虚拟人物助理’, ‘refresh_token’: ‘25.ccc2be055d9e6273d3c0bad9b8bb2368.315360000.1901785415.282335-19345000’, ‘session_secret’: ‘a0a53e0d2183b7145217373b71784075’, ‘expires_in’: 2592000}<br>audio_voice_assistant_get<br>SUCCESS WITH TOKEN: 24.0ed58d5f890b6388b8e1fbb4f595e64e.2592000.1589017415.282335-19345000  EXPIRES IN SECONDS: 2592000<br>Request time cost 1.736482<br>{“corpus_no”:”6813645276203395866”,”err_msg”:”success.”,”err_no”:0,”result”:[“Beijing Cody girl”],”sn”:”487908489041586425415”}</p>
<p>```<br><img src="https://ae01.alicdn.com/kf/H119a0599495846b8aaf1762ffbe78a6aV.png" alt="8"><br>“result”:[“Beijing Cody girl”]中的内容就是识别的内容，在程序根目录也会生成result.txt文件也可以查看。</p>
<p>ok，大概就是这个样子，我要去研究pcm这个鬼东西了。。。</p>

    </div>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <div id="comment">
        <div id="gitalk-container">
        </div>
    </div>
    
</div>
                     
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 2019 - 2021 云淡风轻
            <span class="footer-icon">
                <a-icon type="flag" theme="filled" /></span>
            @Ne-21
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/korilin/hexo-theme-particle">Particle Theme</a></div>
        
        <div>
            备案号：<a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">
                <a target="_blank" href="https://www.beian.miit.gov.cn" rel="nofollow noopener">冀ICP备19031443号</a><br><a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="https://imgs.521daigua.cn/%E6%A0%B7%E5%BC%8F%E5%9B%BE.7cf927c.png" width="300px" height="20px"></a><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?46c8202ccbfe91fef8f7d5fddc0ce94a";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script>
            </a>
        </div>
        
    </div>

</footer>

<script src="/js/highlight.min.js"></script>
<script src="/js/particle.js"></script>
                </div>
            </div>
        </transition>
    </div>

    <script>
    new Vue({
        el: "#layout",
        data: {
            show_page: false,
            onload_menu: false,
            menu_show: false,
            card_top: 100
        },
        created: function () {
            var that = this
            window.onload = function () {
                that.show_page = true
                document.getElementById("loadcontent").style.opacity = 0
                setTimeout(function () {
                    document.getElementById("loadleft").style.width = 0
                    document.getElementById("loadright").style.width = 0
                }, 300)
                setTimeout(function () {
                    document.getElementById("loading").style = "display:none"
                }, 600)
            }
        },
        mounted: function () {
            var that = this
            window.addEventListener('scroll', function (e) {
                that.menu_show = false
            })
        },
        methods: {
            home_click: function () {
                window.scrollTo({
                    top: window.innerHeight - 80,
                    behavior: "smooth",
                });
            }
        }
    })
</script>

<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'hexo-theme-particle',      // The repository of store comments,
        owner: 'korilin',
        admin: ['korilin'],
        language: 'en',
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: true  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>

</body>

</html>